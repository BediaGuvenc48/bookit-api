<!-- this is a very simple single page application using AzureAD -->
<!-- for demonstration, this page is placed inside spring boot project, but it can be placed in any web server. -->
<html>
<header>
    <script src="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.1.0/js/okta-sign-in.min.js"
            type="text/javascript"></script>
    <link href="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.1.0/css/okta-sign-in.min.css"
          type="text/css" rel="stylesheet">
    <link href="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.1.0/css/okta-theme.css" type="text/css"
          rel="stylesheet">
    <script>
        // const azureConfig = {
        //     instance: 'https://login.microsoftonline.com/',
        //     tenant: 'common', // TODO change to common?
        //     clientId: 'ENTER YOUR CLIENT ID HERE',
        //     cacheLocation: 'localStorage', // enable this for IE, as sessionStorage does not work for localhost.
        //     endpoints: {
        //         graphApiUri: "https://graph.microsoft.com"
        //     }
        // };
        //
        // const authContext = new AuthenticationContext(azureConfig);
        // console.log(authContext);
        //
        // const isCallback = authContext.isCallback(window.location.hash);
        // authContext.handleWindowCallback();
        //
        // if (isCallback && !authContext.getLoginError()) {
        //     console.log('check login...');
        //     window.location = authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST);
        // }
        const data = {
            baseUrl: 'https://dev-621718.oktapreview.com',
            clientId: '0oad25jpgsJEyvhpQ0h7',
            authParams: {
                issuer: 'https://dev-621718.oktapreview.com/oauth2/default',
                // authorizeUrl: 'https://your-org.okta.com/oauth2/default/v1/authorize',
                responseType: ['id_token', 'token'],
                scopes: ['openid', 'email', 'profile'],
            },
            idps: [
                {type: 'MICROSOFT', id: '0oad6imz9flkC78vp0h7'}
            ],
            idpDisplay: 'PRIMARY',
        };
        data.redirectUri = window.location.href; // simple single page app
        // setup the widget
        window.oktaSignIn = new OktaSignIn(data);

        function logout() {
            oktaSignIn.signOut(() => {
                oktaSignIn.tokenManager.clear();
                location.reload();
            });
        }
    </script>
</header>
<body>
<!-- show login info -->
<div id="info">N/A (make sure you entered your client id in the javascript of this page)</div>
<div id="okta-login-container"></div>
<button onClick="logout()">Logout</button>
<script>
    // Check if we already have an access token
    const token = oktaSignIn.tokenManager.get('my_access_token');
    // if we do great, just go with it!
    if (token) {
        const info = document.getElementById('info');
        const idToken = oktaSignIn.tokenManager.get('my_id_token')
        if (idToken) {
            console.log(idToken);
            info.innerText = `name: ${idToken.claims.name} email: ${idToken.claims.email} username: ${idToken.claims.preferred_username}`
        } else {
            info.innerText = 'not logged in yet';
        }

    } else {
        // otherwise show the login widget
        oktaSignIn.renderEl(
            {el: '#okta-login-container'},
            function (response) {
                // check if success
                if (response.status === 'SUCCESS') {
                    // for our example we have the id token and the access token
                    oktaSignIn.tokenManager.add('my_id_token', response[0]);
                    oktaSignIn.tokenManager.add('my_access_token', response[1]);
                    // hide the widget
                    oktaSignIn.hide();
                    const info = document.getElementById('info');
                    const idToken = oktaSignIn.tokenManager.get('my_id_token')
                    if (idToken) {
                        console.log(idToken);
                        info.innerText = `name: ${idToken.claims.name} email: ${idToken.claims.email} username: ${idToken.claims.preferred_username}`
                    } else {
                        info.innerText = 'not logged in yet';
                    }

                }
            },
            function (err) {
                // handle any errors
                console.log(err);
            }
        );
    }
</script>

<!-- AJAX Call with token -->
<div id="result">no call yet.</div>
<script>
    const result = document.getElementById('result');

    function callApi() {
        // Acquire token, add the token to the header and make ajax call.
        const token = oktaSignIn.tokenManager.get('my_access_token').accessToken
        const headers = new Headers({
            'Accept': 'application/json;charset=UTF-8',
            'Content-Type': 'application/json;charset=UTF-8',
            'Authorization': 'Bearer ' + token
        });

        const params = {
            method: 'GET',
            headers: headers
        };

        // change the user to where your service is
        fetch('http://localhost:8080/v1/ping', params).then((response) => {
            console.log('response.status', response.status);
            console.log('response.body', response.body);
            return response.json();
        }).then((json) => {
            console.log('JSON', json);
            result.innerText = JSON.stringify(json);
        }).catch(function (err) {
            console.log('Fetch Error: ', err);
        });
    }

    function callApiWithoutToken() {
        const headers = new Headers({
            'Accept': 'application/json;charset=UTF-8',
            'Content-Type': 'application/json;charset=UTF-8'
        });

        const params = {
            method: 'GET',
            headers: headers
        };

        // change the user to where your service is
        fetch('http://localhost:8080/v1/ping', params).then((response) => {
            console.log('response.status', response.status);
            console.log('response.body', response.body);
            return response.json();
        }).then((json) => {
            console.log('JSON', json);
            result.innerText = JSON.stringify(json);
        }).catch(function (err) {
            console.log('Fetch Error: ', err);
        });
    }

</script>
<button onClick="callApi()">Call API with token</button>
<button onClick="callApiWithoutToken()">Call API without token</button>
</body>
</html>
